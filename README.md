# 电影预订系统 (Movie Reservation System - MRS)

## 目录

1.  [项目概述](#1-项目概述)
2.  [核心功能](#2-核心功能)
3.  [技术选型](#3-技术选型)
4.  [架构设计](#4-架构设计)
    *   [分层架构](#41-分层架构)
    *   [模块化](#42-模块化)
5.  [数据模型概览](#5-数据模型概览)
6.  [API 端点概览](#6-api-端点概览)
7.  [关键设计考量](#7-关键设计考量)
    *   [高并发应对](#71-高并发应对)
    *   [缓存策略](#72-缓存策略)
    *   [数据一致性](#73-数据一致性)
    *   [可扩展性与未来演进](#74-可扩展性与未来演进)
8.  [环境要求与运行](#8-环境要求与运行)
9.  [项目文档](#9-项目文档)
10. [开发路线图](#10-开发路线图)

## 1. 项目概述

电影预订系统 (MRS) 是一个后端服务，旨在为用户提供一个完整、高效、可靠的电影票在线预订解决方案。系统支持用户注册登录、浏览电影、查询场次、选择座位、完成预订等操作。同时，它也为管理员提供了管理电影、排片、查看运营数据等后台功能。

本项目致力于构建一个具备工业级强度的应用，特别关注在高并发场景下的系统性能、数据一致性和可扩展性。我们将采用现代化的架构设计和技术栈，为未来的功能迭代和系统演进奠定坚实的基础。

**核心目标：**

*   实现健壮的业务逻辑，尤其是高并发下的座位预订与库存管理。
*   构建清晰、分层、模块化的应用架构，易于理解、维护和扩展。
*   设计和实现高效的缓存策略，提升系统响应速度，降低数据库负载。
*   确保用户数据和交易的安全性与一致性。
*   为未来可能的微服务化、数据分片等演进做好架构准备。

## 2. 核心功能

### 2.1 用户认证与授权

*   **用户注册与登录**：提供安全的账户创建和登录机制。
*   **角色管理**：
    *   **普通用户 (User)**：浏览电影、查询场次、预订座位、查看和取消个人订单。
    *   **管理员 (Admin)**：拥有用户权限，并能管理电影信息、影厅座位、放映计划、查看所有订单及系统报告。
*   **权限控制**：基于角色的访问控制 (RBAC) 保护系统资源。

### 2.2 电影与放映管理 (管理员)

*   **电影信息管理**：增删改查电影详情（标题、描述、海报、时长、类型等）。
*   **影厅与座位管理**：配置影厅信息及座位布局。
*   **放映计划管理 (Showtime)**：为电影安排放映场次，关联影厅、时间，并设定票价。

### 2.3 预订管理 (用户)

*   **电影与场次浏览**：高效查询和展示电影列表、特定日期的放映场次。
*   **座位选择与预订**：实时查看场次座位图及可用状态，选择座位并完成预订下单。
*   **订单管理**：查看个人预订记录，支持取消未开始的订单。

### 2.4 报告与分析 (管理员)

*   **运营数据报告**：查看预订统计、上座率、收入分析等。

## 3. 技术选型

*   **编程语言**: Go (Golang)
*   **Web 框架**: Gin (提供高性能的 HTTP 路由和中间件支持)
*   **数据库**: MySQL (关系型数据库)
*   **ORM / 数据库驱动**: GORM (功能丰富的 ORM 库)
*   **缓存**: Redis (用于数据缓存、分布式锁、会话管理等)
*   **配置管理**: Viper (支持多种配置源和格式)
*   **日志库**: Zap (高性能结构化日志库)
*   **认证机制**: JWT (JSON Web Tokens)
*   **API 类型**: RESTful API
*   **容器化**: Docker, Docker Compose
*   **未来演进技术储备**:
    *   **服务间通信**: gRPC
    *   **消息队列**: Apache Kafka / NATS (用于异步任务、削峰填谷)
    *   **服务发现/注册**: Consul / etcd
    *   **配置中心**: Consul / etcd / Apollo
    *   **分布式追踪**: Jaeger / Zipkin (基于 OpenTelemetry)
    *   **数据库分片方案**: Vitess / Apache ShardingSphere / 自定义路由
    *   **全局 ID 生成**: Snowflake / UUID v7

## 4. 架构设计

本项目采用清晰的分层架构和模块化设计，以实现高内聚、低耦合，并为未来的扩展和维护提供便利。

### 4.1 分层架构

遵循经典的领域驱动设计 (DDD) 的分层思想，主要包括：

*   **接口层 (API Layer - `internal/api`)**: 负责处理外部 HTTP 请求，进行参数校验、DTO 转换，并调用应用服务。包含 HTTP 处理器 (Handlers)、中间件 (Middleware) 和路由 (Router)。
*   **应用层 (Application Layer - `internal/app`)**: 编排领域服务和基础设施服务，执行具体的业务用例。它不包含业务规则，而是协调任务的执行。
*   **领域层 (Domain Layer - `internal/domain`)**: 包含核心业务逻辑、领域实体 (Entities)、值对象 (Value Objects)、领域服务以及仓库接口 (Repository Interfaces)。这是业务规则的所在地。
*   **基础设施层 (Infrastructure Layer - `internal/infrastructure`)**: 提供与外部世界的集成，如数据库交互 (Persistence)、缓存服务 (Cache)、消息队列 (MessageQueue)、配置文件加载 (Config) 等。它负责实现领域层定义的接口。

### 4.2 模块化

项目代码在 `internal` 目录下按功能和职责进行模块化组织。详细结构请参见 [PROJECT_STRUCTURE.md](./PROJECT_STRUCTURE.md)。

## 5. 数据模型概览

系统核心数据实体包括用户 (User)、角色 (Role)、电影 (Movie)、类型 (Genre)、影厅 (CinemaHall)、放映时间 (Showtime)、座位 (Seat)、预订 (Booking) 等。

详细的数据表结构、字段定义及其关系请参见 [DATA_MODEL.md](./DATA_MODEL.md)。

## 6. API 端点概览

主要 API 端点将围绕认证、用户、电影、放映时间、预订和报告等资源进行设计。
示例 (详见后续 API 文档)：

*   **认证**: `POST /api/auth/register`, `POST /api/auth/login`
*   **电影**: `GET /api/movies`, `GET /api/movies/{id}`, `POST /api/admin/movies` (Admin)
*   **放映时间**: `GET /api/showtimes?date=...`, `GET /api/showtimes/{id}/seats`
*   **预订**: `POST /api/bookings`, `GET /api/bookings/me`

## 7. 关键设计考量

### 7.1 高并发应对

*   **识别场景**: 热门电影查询、开售抢票。
*   **优化读取**: 大量使用缓存减少数据库压力。
*   **并发控制**: 针对座位预订等写操作，采用分布式锁 (Redis SETNX) 或数据库乐观/悲观锁，防止超卖和数据不一致。
*   **异步处理**: 对于非核心、耗时的操作（如发送通知），考虑引入消息队列进行异步处理，提高主流程响应速度。

### 7.2 缓存策略

*   **工具**: Redis。
*   **模式**: 主要采用 Cache-Aside (旁路缓存)。
*   **内容**: 缓存静态/准静态数据（电影详情、类型列表），热点动态数据（场次列表、座位图状态）。
*   **管理**: 设计合理的缓存键、过期策略、更新机制（写后失效或更新），并防范缓存穿透、击穿、雪崩问题。

### 7.3 数据一致性

*   **事务管理**: 关键数据库操作使用事务保证原子性。
*   **分布式事务 (未来)**: 若演进为微服务，将考虑采用 Saga、TCC 或基于消息的最终一致性方案。
*   **幂等性设计**: 关键写操作 API (如创建订单) 需保证幂等性。

### 7.4 可扩展性与未来演进

*   **无状态服务**: HTTP API 服务设计为无状态，便于水平扩展。
*   **接口驱动**: 强依赖接口而非具体实现，尤其在领域层和应用层。
*   **模块解耦**: 清晰的模块边界为未来拆分为微服务奠定基础。
*   **配置外化**: 通过配置中心管理动态配置。
*   **数据分片预研**: 预留基于业务键（如用户ID、影院ID）进行数据分片的可能性。
*   **全局唯一ID**: 考虑引入 Snowflake 等方案生成分布式环境下的唯一ID。
*   **可观测性**: 构建完善的日志、指标、追踪体系。

## 8. 环境要求与运行

*   **Go**: 1.18 或更高版本
*   **MySQL**: 8.0 或更高版本
*   **Redis**: 6.x 或更高版本
*   **Docker & Docker Compose** (推荐用于本地开发)

具体的安装、配置和运行步骤将在项目初始化后补充。

```bash
# 示例 (占位)
git clone <repository-url>
cd mrs
cp configs/app.example.yaml configs/app.yaml # 编辑配置
docker-compose up --build -d
# ./scripts/run_migrations.sh # (假设有迁移脚本)
# ./mrs-server # (如果手动运行二进制文件)

```

## 9. 项目文档

- **[PROJECT_STRUCTURE.md](./PROJECT_STRUCTURE.md)**: 详细的项目目录结构和模块说明。
- **[DATA_MODEL.md](./DATA_MODEL.md)**: 数据库表结构、字段定义和关系。
- **[DEVELOPMENT_ROADMAP.md](./DEVELOPMENT_ROADMAP.md)**: 项目的阶段性开发计划和目标。
- **(未来) API_SPECIFICATION.md**: API 端点详细定义 (例如 OpenAPI/Swagger 规范)。

## 10. 开发路线图

项目将采用迭代式开发，分为多个阶段，每个阶段都有明确的目标和产出。详情请参见 [DEVELOPMENT_ROADMAP.md](./DEVELOPMENT_ROADMAP.md)。
